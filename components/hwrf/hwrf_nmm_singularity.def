# Sigularity definition file for WRF-NMM/WPS.
# Builds from base image in components/base
Bootstrap: localimage
From: /nwp-container/components/base/base-image.img

%help
Singularity definition for the WRF-NMM/HWRF image.

Contains: Minimal CentOS7 + Development Tools + WRF-NMM/WPS + dependencies

%labels
Maintainer Tyler Wixtrom <tyler.wixtrom@ttu.edu>
Application_Stack Development Tools + WRF-NMM/WPS from Hurricane WRF
Image_Version 1.0

%post
export dir=/hwrfrun/sorc
umask 0002 \
 && mkdir -p ${dir}
cd ${dir}

# set at end of compile too
export WRF_VERSION="4.0a"
export WPS_VERSION="4.0a"
#
# Download original sources
#
umask 0002 \
 && curl -SL https://www.dtcenter.org/sites/default/files/HWRF_v${WRF_VERSION}_WRF.tar.gz | tar zxC ${dir} \
 && curl -SL https://www.dtcenter.org/sites/default/files/HWRF_v${WPS_VERSION}_WPS.tar.gz | tar zxC ${dir}

#
# Set environment for interactive container shells
#
cd ${dir}
echo export LDFLAGS="-lm" >> /home/.bashrc \
 && echo export LD_LIBRARY_PATH="/usr/lib64/openmpi/lib:/comsoftware/libs/netcdf/lib" >> /home/.bashrc \
 && echo export PATH="/usr/lib64/openmpi/bin:$PATH" >> /home/.bashrc \
 && echo setenv LDFLAGS "-lm" >> /home/.cshrc \
 && echo setenv LD_LIBRARY_PATH "/usr/lib64/openmpi/lib:/comsoftware/libs/netcdf/lib" >> /home/.cshrc \
 && echo setenv PATH "/usr/lib64/openmpi/bin:$PATH" >> /home/.cshrc

# Build WRF first
# input 35 and 1 to configure script

umask 0002 \
 && export HWRF=1 \
 && export WRF_NMM_CORE=1 \
 && export WRF_NMM_NEST=1 \
 && export WRFIO_NCD_LARGE_FILE_SUPPORT=1 \
 && export NETCDF=/comsoftware/libs/netcdf/ \
 && export JASPERINC=/usr/include/jasper/ \
 && export JASPERLIB=/usr/lib64/ \
 && export J='-j 4' \
 && cd ./WRF \
 && ./configure <<< $'35\r1\r' \
 && /bin/csh ./compile nmm_real > compile_wrf_arw_opt35.1.log 2>&1

# Build WPS second
#
# input 1 to configure script (gfortran serial build)
export WRF_DIR=${dir}/WRF
umask 0002 \
 && cd ${dir}/WPS \
 && echo export NETCDF=/comsoftware/libs/netcdf/ \
 && export JASPERINC=/usr/include/jasper/ \
 && export JASPERLIB=/usr/lib64/ \
 && ./configure <<< $'1\r' \
 && /bin/csh ./compile > compile_wps.log 2>&1

export LD_LIBRARY_PATH=/usr/lib64/openmpi/lib:/comsoftware/libs/netcdf/lib
export PATH=/usr/lib64/openmpi/bin:$PATH

# remove links from run directory
rm ${dir}/WRF/run/*.exe

mkdir -p /lustre

%files
/nwp-container/components/hwrf/sub_wrf.bash /data/scripts/sub_wrf.bash
/nwp-container/components/hwrf/run_wrf.bash /data/scripts/run_wrf.bash
/nwp-container/components/hwrf/namelist.wps /data/scripts/namelist.wps
/nwp-container/components/hwrf/namelist.input /data/scripts/namelist.input

%environment
export LDFLAGS="-lm"
export LD_LIBRARY_PATH="/usr/lib64/openmpi/lib:/comsoftware/libs/netcdf/lib"
export PATH="/usr/lib64/openmpi/bin:$PATH"
export LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"
# export WRF_VERSION="4.1.2"
# export WPS_VERSION="4.1"
